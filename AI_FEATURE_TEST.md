# AI 功能全面测试方案

## 测试目标
验证所有AI功能正常工作，并测量优化后的token消耗

---

## 📋 测试用例列表

### **测试1：简单问候（闲聊模式 - Token优化）**
**测试目的**：验证闲聊模式的极简上下文优化

**测试消息**：
```
你好
```

**预期行为**：
- ✅ 只调用1次API（不是2次）
- ✅ 流式输出自然流畅（6-13ms/字符，标点停顿）
- ✅ 保持角色身份（不说"AI助手"）
- ✅ 简短友好的回复

**预期Token消耗**：
- 输入：~2,260 tokens（系统提示 + 用户身份 + 当前消息）
- 输出：~120-150 tokens
- **总计：~2,400 tokens**

---

### **测试2：角色身份一致性**
**测试目的**：验证AI始终保持设定的角色身份

**测试消息**：
```
你是谁呀？你是AI助手吗？
```

**预期行为**：
- ✅ 完全以角色身份回答
- ✅ 不自称"AI助手"、"我是AI"
- ✅ 展现角色性格特征

**预期Token消耗**：
- 输入：~2,280 tokens（包含对话历史）
- 输出：~180-220 tokens
- **总计：~2,500 tokens**

---

### **测试3：记忆检索（短期记忆）**
**测试目的**：验证AI能记住刚才的对话

**测试消息**：
```
我刚才问你什么了？
```

**预期行为**：
- ✅ 准确回忆上一轮对话内容
- ✅ 自然引用之前的话题
- ✅ 保持角色身份

**预期Token消耗**：
- 输入：~2,450 tokens（系统 + 身份 + 2轮对话历史）
- 输出：~150-200 tokens
- **总计：~2,650 tokens**

---

### **测试4：工具调用 - 资产管理**
**测试目的**：验证工具调用功能和Function Calling

**测试消息**：
```
帮我看看有哪些资产
```

**预期行为**：
- ✅ 自动调用 `list_assets` 工具
- ✅ 显示真实的资产列表（或提示未连接）
- ✅ 不编造不存在的资产
- ✅ 流式输出工具调用结果

**预期Token消耗**：
- 输入：~3,200 tokens（系统 + 工具定义 + 历史）
- 输出：~250-400 tokens（取决于资产数量）
- 工具调用轮次：1-2次
- **总计：~3,600-3,800 tokens**

---

### **测试5：编程问题（代码生成）**
**测试目的**：验证编程助手能力和代码质量

**测试消息**：
```
用Python写一个快速排序算法
```

**预期行为**：
- ✅ 生成完整可运行的代码
- ✅ 包含注释和解释
- ✅ 使用Markdown代码块格式
- ✅ 保持角色身份（但仍专业）

**预期Token消耗**：
- 输入：~2,450 tokens（闲聊模式，跳过资产上下文）
- 输出：~350-500 tokens（包含代码）
- **总计：~2,900 tokens**

---

### **测试6：UE开发问题**
**测试目的**：验证UE专业知识

**测试消息**：
```
UE5中如何优化材质性能？
```

**预期行为**：
- ✅ 给出专业的UE优化建议
- ✅ 提供具体步骤或示例
- ✅ 使用技术术语但易懂

**预期Token消耗**：
- 输入：~2,500 tokens
- 输出：~400-600 tokens
- **总计：~3,000 tokens**

---

### **测试7：配置工具调用**
**测试目的**：验证配置管理工具

**测试消息**：
```
有哪些配置模板？
```

**预期行为**：
- ✅ 调用 `list_config_templates` 工具
- ✅ 显示可用的配置模板列表
- ✅ 简洁清晰的展示

**预期Token消耗**：
- 输入：~3,300 tokens
- 输出：~200-300 tokens
- **总计：~3,600 tokens**

---

### **测试8：站点推荐**
**测试目的**：验证知识库检索

**测试消息**：
```
推荐一些UE学习网站
```

**预期行为**：
- ✅ 调用 `search_sites` 或相关工具
- ✅ 返回真实的网站列表
- ✅ 不编造链接

**预期Token消耗**：
- 输入：~3,400 tokens
- 输出：~250-350 tokens
- **总计：~3,750 tokens**

---

### **测试9：长期记忆检索**
**测试目的**：验证FAISS向量记忆系统

**测试消息**：
```
你还记得我喜欢什么游戏吗？
```

**预期行为**：
- ✅ 触发FAISS语义检索
- ✅ 准确回忆用户偏好
- ✅ 自然引用历史记忆
- ✅ 展现记忆连贯性

**预期Token消耗**：
- 输入：~2,700 tokens（包含检索到的记忆）
- 输出：~200-250 tokens
- **总计：~2,950 tokens**

---

### **测试10：复杂多轮对话**
**测试目的**：验证上下文理解和连贯性

**测试序列**：
```
1. "我想做一个恐怖游戏"
2. "应该用什么引擎？"（测试指代消歧）
3. "具体怎么开始？"（测试连续性）
```

**预期行为**：
- ✅ 理解"什么引擎"指的是游戏引擎
- ✅ "怎么开始"指的是开发恐怖游戏
- ✅ 保持话题连贯性
- ✅ 可能触发Query Rewriting

**预期Token消耗（每轮）**：
- 第1轮：~2,400 tokens（输入2250 + 输出150）
- 第2轮：~2,650 tokens（输入2400 + 输出250）
- 第3轮：~3,000 tokens（输入2600 + 输出400）
- **总计：~8,050 tokens（3轮累计）**

---

## 📊 整体Token消耗预估

### **优化前 vs 优化后对比**

| 场景 | 优化前 | 优化后 | 节省 |
|------|--------|--------|------|
| 简单问候 | ~4,700 | ~2,400 | **49%** |
| 角色对话 | ~5,000 | ~2,500 | **50%** |
| 工具调用 | ~5,500 | ~3,700 | **33%** |
| 编程问题 | ~5,200 | ~2,900 | **44%** |
| 记忆检索 | ~5,800 | ~2,950 | **49%** |

### **关键优化点**
1. ✅ **消除重复API调用**：简单问候从2次 → 1次
2. ✅ **闲聊模式优化**：跳过资产/配置/站点上下文
3. ✅ **Prompt Cache**：系统提示词缓存（理论上）
4. ✅ **智能上下文裁剪**：根据意图动态调整上下文

---

## 🎯 测试执行步骤

### 1. 清空对话
重启程序或清空对话历史，确保干净的测试环境

### 2. 按顺序执行测试
逐个发送测试消息，观察：
- Token消耗是否符合预期
- API调用次数（应该都是1次）
- 流式输出效果
- 角色身份一致性
- 功能正确性

### 3. 记录实际结果
在每个测试后记录：
- 实际输入token
- 实际输出token
- 总token消耗
- 响应时间
- 是否符合预期行为

### 4. 对比分析
将实际结果与预期对比，计算优化效果

---

## 🔍 重点观察项

### **必须通过的项目**
1. ❌ **绝对不能出现2次API调用**（除非真的需要多轮工具调用）
2. ✅ **Token消耗必须在预期范围内**（±10%误差可接受）
3. ✅ **流式输出必须自然流畅**（不生硬，有节奏感）
4. ✅ **角色身份必须一致**（不能自称AI助手）
5. ✅ **工具调用必须准确**（不编造数据）
6. ✅ **记忆检索必须有效**（能回忆历史信息）

### **性能指标**
- 平均响应时间：< 3秒
- 流式输出速度：~90字符/秒
- Token优化率：> 40%
- 用户满意度：主观评价

---

## 📝 测试结果记录模板

```
测试时间：2025-11-08 22:xx

| 测试项 | 输入Token | 输出Token | 总Token | API次数 | 通过 |
|--------|-----------|-----------|---------|---------|------|
| 1. 简单问候 | | | | | ☐ |
| 2. 角色身份 | | | | | ☐ |
| 3. 记忆检索 | | | | | ☐ |
| 4. 资产管理 | | | | | ☐ |
| 5. 编程问题 | | | | | ☐ |
| 6. UE开发 | | | | | ☐ |
| 7. 配置工具 | | | | | ☐ |
| 8. 站点推荐 | | | | | ☐ |
| 9. 长期记忆 | | | | | ☐ |
| 10. 多轮对话 | | | | | ☐ |

总Token消耗：_______
平均每轮消耗：_______
优化效果：_______%
```

---

## ⚠️ 常见问题排查

### 如果Token消耗过高
1. 检查是否触发了多次API调用
2. 确认闲聊模式是否生效
3. 查看上下文是否包含不必要的内容
4. 检查工具定义是否过大

### 如果流式输出不自然
1. 确认延迟参数（6-13ms基础延迟）
2. 检查随机波动是否生效
3. 观察标点停顿是否合理

### 如果角色身份混乱
1. 检查系统提示词是否正确
2. 确认用户身份是否成功加载
3. 查看记忆系统是否返回正确数据

---

## 🎉 预期测试结果

如果优化成功，应该看到：
- ✅ 所有简单对话的token消耗 < 3,000
- ✅ 工具调用的token消耗 < 4,000
- ✅ 整体token节省 > 40%
- ✅ 流式输出自然流畅
- ✅ 角色身份始终一致
- ✅ 所有功能正常工作

**祝测试顺利！** 🚀

