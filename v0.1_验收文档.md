# AI Deep Integration v0.1 验收文档

## 变更要点

### 核心功能

1. **语义意图解析** - IntentEngine
   - 使用 BAAI/bge-small-zh-v1.5 嵌入模型
   - 延迟加载避免启动卡顿
   - 支持 8 类意图分类
   - 模型加载失败时自动降级到规则匹配

2. **运行态上下文管理** - RuntimeContextManager
   - 持久化到 user_data_dir/runtime_context.json
   - 自动恢复上次状态（当前模块、选中资产、最近操作）
   - 异常安全：读取失败不抛出异常

3. **本地文档检索** - LocalDocIndex  
   - Chroma 向量数据库持久化
   - 索引项目文档、README、配置模板
   - 支持语义搜索

4. **远程代码检索** - GitHubConnector/GiteeConnector
   - GitHub 代码搜索（PyGithub）
   - Token 优先级：环境变量 > config
   - Gitee stub 接口

5. **上下文融合增强**
   - ContextManager 集成上述所有组件
   - 检索优先级：本地 → 远程
   - 证据附带来源标签
   - Debug 模式输出完整快照

### 文件变更

**新增**：4个
- `modules/ai_assistant/logic/intent_parser.py` (270 行)
- `modules/ai_assistant/logic/runtime_context.py` (282 行)
- `modules/ai_assistant/logic/local_retriever.py` (302 行)
- `modules/ai_assistant/logic/remote_retriever.py` (298 行)

**修改**：7个
- `modules/ai_assistant/logic/context_manager.py` (+74 行)
- `modules/ai_assistant/ai_assistant.py` (+42 行)
- `modules/ai_assistant/ui/chat_window.py` (+20 行)
- `ui/main_window_handlers/module_loader.py` (+29 行)
- `modules/asset_manager/logic/asset_manager_logic.py` (+1 行)
- `requirements.txt` (+11 行)
- `resources/templates/global_settings.json` (+4 行)

**测试**：4个
- `tests/test_ai_assistant/test_intent_parser.py` (193 行)
- `tests/test_ai_assistant/test_runtime_context.py` (143 行)
- `tests/test_ai_assistant/test_local_retriever.py` (157 行)
- `tests/test_ai_assistant/test_remote_retriever.py` (137 行)

**Commits**：12个独立提交

---

## 如何验证

### 前置条件

1. 安装新依赖：
```bash
pip install sentence-transformers chromadb PyGithub
```

2. （可选）配置 GitHub Token：
```bash
# 方式1：环境变量
export GITHUB_TOKEN=your_token_here

# 方式2：修改 global_settings.json
# 设置 "github_token": "your_token_here"
```

### 验证步骤

#### 1. 运行单元测试

```bash
# 快速测试（规则匹配模式，不需要下载模型）
pytest tests/test_ai_assistant/test_intent_parser.py::TestIntentParserRuleBased -v

# 运行态上下文测试
pytest tests/test_ai_assistant/test_runtime_context.py -v

# 本地检索测试（需要 chromadb）
pytest tests/test_ai_assistant/test_local_retriever.py -v

# 远程检索测试（mock，不需要 token）
pytest tests/test_ai_assistant/test_remote_retriever.py -v
```

**预期结果**：
- 意图解析准确率 ≥ 85%
- 所有状态管理测试通过
- Chroma 持久化测试通过
- GitHub 接口测试通过

#### 2. 启动程序验证

```bash
python main.py
```

**验证要点**：

1. **程序能正常启动**（嵌入模型异步加载，不卡顿）
2. **打开 AI 助手模块**
3. **测试语义意图**：
   - 输入："我想找材质资产"（不包含"搜索"关键词）
   - 预期：AI 能理解意图并返回资产信息
4. **测试运行态上下文**：
   - 切换到资产管理器模块
   - 回到 AI 助手询问："我现在在哪个模块？"
   - 预期：AI 回答"asset_manager"
5. **测试持久化**：
   - 关闭程序
   - 重新启动
   - 询问："我上次在哪个模块？"
   - 预期：AI 能记住上次的模块

#### 3. 检查日志

查看日志文件确认：

```
2025-xx-xx - intent_parser - INFO - 意图引擎初始化（延迟加载模式）
2025-xx-xx - runtime_context - INFO - 已从缓存恢复运行态
2025-xx-xx - context_manager - INFO - 智能上下文管理器初始化完成
```

#### 4. 验证无写入副作用

- 确认所有功能都是只读的
- AI 不能修改文件
- AI 不能删除资产
- AI 不能更改配置

---

## 已验证的功能

- [x] IntentEngine 延迟加载（不影响启动速度）
- [x] 语义意图分类（不依赖关键词）
- [x] RuntimeContext 持久化（重启后恢复）
- [x] 本地文档检索（Chroma 向量搜索）
- [x] 远程代码检索（GitHub API）
- [x] 检索证据附带来源标签
- [x] Debug 模式输出上下文快照
- [x] 原有聊天/记忆功能正常
- [x] 无写入副作用

---

## 回滚方式

如需回滚 v0.1：

```bash
# 方式1：删除分支
git branch -D feature/ai-deep-integration
git checkout master

# 方式2：回退 commits
git reset --hard dbde735  # 回退到 v0.1 之前的提交
```

---

## 下一步

等待 "继续 v0.2" 指令后，开始实现：
- Tools Registry（工具注册表）
- Action Engine（两段式工具调用）
- OpenAI Function Calling 集成

---

**状态**：v0.1 已完成，等待验收 ✅

