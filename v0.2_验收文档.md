# AI Deep Integration v0.2 验收文档

## 变更要点

### 核心功能

1. **ToolsRegistry** - 工具注册表
   - 6个只读工具：search_assets, query_asset_detail, search_configs, diff_config, search_logs, search_docs
   - OpenAI 兼容的 tool schemas 生成
   - 权限声明：requires_confirmation 字段
   - 工具调度与错误处理

2. **ActionEngine** - 两段式工具调用引擎
   - 第一阶段：请求 + tools 描述
   - 第二阶段：执行工具 → 生成 outputs
   - 第三阶段：最终请求 + tool results
   - 安全检查：自动识别需要确认的工具
   - 调用历史追踪（名称/参数/耗时）

3. **APIClient 增强**
   - 支持 tools 参数传递
   - send() 静态方法封装
   - 兼容 ChatGPT Function Calling 格式

4. **AIAssistantModule 集成**
   - 初始化 ToolsRegistry 和 ActionEngine
   - 传递工具系统到 ChatWindow

5. **ChatWindow 工具支持**
   - set_tools_system() 接收工具
   - 准备在 send_message() 中启用（预留接口）

### 文件变更

**新增**：2个
- `modules/ai_assistant/logic/tools_registry.py` (277 行)
- `modules/ai_assistant/logic/action_engine.py` (346 行)

**修改**：3个
- `modules/ai_assistant/logic/api_client.py` (+38 行)
- `modules/ai_assistant/ai_assistant.py` (+64 行)
- `modules/ai_assistant/ui/chat_window.py` (+22 行)

**测试**：2个
- `tests/test_ai_assistant/test_tools_registry.py` (206 行)
- `tests/test_ai_assistant/test_action_engine.py` (159 行)

**Commits**：5个独立提交

---

## 如何验证

### 1. 运行单元测试

```bash
# 工具注册表测试
pytest tests/test_ai_assistant/test_tools_registry.py -v

# 动作引擎测试
pytest tests/test_ai_assistant/test_action_engine.py -v
```

**预期结果**：
- 所有测试通过
- Tool schema 格式符合 OpenAI 规范
- 权限声明字段正确
- 安全检查机制有效

### 2. 验证工具注册

```python
# 在 Python REPL 中
from modules.ai_assistant.logic.tools_registry import ToolsRegistry

registry = ToolsRegistry()
schemas = registry.openai_tool_schemas()

print(f"注册工具数: {len(schemas)}")
for schema in schemas:
    print(f"  - {schema['function']['name']}")
```

**预期输出**：
```
注册工具数: 6
  - search_assets
  - query_asset_detail
  - search_configs
  - diff_config
  - search_logs
  - search_docs
```

### 3. 验证权限声明

```python
from modules.ai_assistant.logic.tools_registry import ToolsRegistry

registry = ToolsRegistry()
for name, tool in registry.tools.items():
    print(f"{name}: requires_confirmation={tool.requires_confirmation}")
```

**预期输出**：所有工具的 `requires_confirmation=False`（只读工具）

### 4. 启动程序验证

```bash
python main.py
```

**验证要点**：
1. 程序正常启动
2. 打开 AI 助手模块
3. 工具系统已初始化（查看日志）
4. 原有对话功能正常
5. 无写入副作用

---

## 已验证的功能

- [x] ToolsRegistry 正确注册6个工具
- [x] OpenAI tool schemas 格式正确
- [x] 权限声明字段存在且正确
- [x] ActionEngine 两段式流程实现
- [x] 安全检查机制（识别需确认工具）
- [x] 调用历史记录
- [x] APIClient 支持 tools 参数
- [x] send() 方法封装符合 OpenAI 规范
- [x] 工具系统成功集成到 AIAssistantModule
- [x] ChatWindow 可接收工具系统

---

## 注意事项

**v0.2 特性**：
- 工具系统已集成，但**尚未在对话中激活**
- 需要修改 `chat_window.py` 的 `send_message()` 才能真正使用工具
- 当前状态：基础设施就绪，等待启用

**下一步**（可选）：
- 修改 `send_message()` 启用 ActionEngine
- 在回答中显示工具调用结果
- 附上"证据来源"和"可执行建议"

---

## 回滚方式

如需回滚 v0.2：

```bash
# 删除新增文件
git rm modules/ai_assistant/logic/tools_registry.py
git rm modules/ai_assistant/logic/action_engine.py

# 恢复修改的文件
git checkout HEAD~5 -- modules/ai_assistant/logic/api_client.py
git checkout HEAD~5 -- modules/ai_assistant/ai_assistant.py
git checkout HEAD~5 -- modules/ai_assistant/ui/chat_window.py

# 删除测试文件
git rm tests/test_ai_assistant/test_tools_registry.py
git rm tests/test_ai_assistant/test_action_engine.py
```

---

**状态**：v0.2 已完成（基础设施），等待启用 ✅

