# Token 极简优化 - 测试指南

## 🎯 测试目标

验证 Token 优化后的功能：
1. ✅ 身份保持（猫娘/汪星人）
2. ✅ 记忆召回（喜好信息）
3. ✅ Token 大幅降低

---

## 🧪 测试用例

### 测试 1：简单问候（身份保持）

**输入**：`你好`

**预期**：
- Token 显示：~300（而非 7000）
- AI 回答包含身份特征（如："汪汪！主人好呀！"）
- 控制台显示：
  ```
  [DEBUG] [Token优化] System Prompt: 你是 AI 助手，你是汪星人...
  [DEBUG] [Token优化] 最终消息数: 2, 工具数: 0
  [DEBUG] Token 使用量 - 本次对话: ~300
  ```

**如果失败（AI 没有身份）**：
- 检查控制台是否有：`[ERROR] 获取身份信息失败`
- 检查 `get_user_identity_minimal()` 的返回值

---

### 测试 2：记忆召回

**输入**：`你还记得我喜欢什么游戏吗`

**预期**：
- Token 显示：~500（而非 7000）
- AI 能回答："你喜欢原神，最喜欢的角色是胡桃"
- 控制台显示：
  ```
  [DEBUG] [Token优化] 加载了 3 条相关记忆: 喜欢原神...
  [DEBUG] Token 使用量 - 本次对话: ~500
  ```

**如果失败（AI 说不记得）**：
- 检查控制台：`[DEBUG] [Token优化] 未找到相关记忆`
- 说明 FAISS 搜索失败或记忆未保存

**修复方案**：
1. 确认记忆已保存：
   - 在设置中查看记忆数量（应该有 82 条用户级记忆）
2. 尝试更宽松的关键词：
   ```python
   needs_memory = any(k in user_message for k in ['记得', '之前', '刚才', '还记得', '知道', '喜欢'])
   ```

---

### 测试 3：使用工具

**输入**：`这个蓝图有什么问题`（需先打开 UE 蓝图编辑器）

**预期**：
- Token 显示：~2000（而非 7000）
- AI 能调用 `validate_blueprint` 工具
- 控制台显示：
  ```
  [DEBUG] [Token优化] 加载了 4 个相关工具（而非全部 16 个）
  [DEBUG] Token 使用量 - 本次对话: ~2000
  ```

---

### 测试 4：连续对话（指代词）

**第 1 次**：`原神好玩吗`

**第 2 次**：`那它的角色呢`（包含指代词"它"）

**预期**：
- 第 2 次 Token：~600（包含上一轮对话）
- AI 能理解"它"指的是"原神"
- 控制台显示：
  ```
  [DEBUG] [Token优化] 加载了 2 条历史消息（最近 1 轮）
  ```

---

## 🔍 调试技巧

### 查看完整的消息结构

在控制台中找到：
```
[DEBUG] [消息结构] 发送给API的完整消息:
  [0] system: xxx
  [1] user: xxx
```

**正常情况：**
- 简单问候：1-2 条消息
- 需要记忆：3-5 条消息
- 使用工具：2-3 条消息

**异常情况：**
- 如果有很多条消息（>10 条），说明历史没有被正确限制
- 如果 system 内容很长，说明没有使用精简版

---

### 查看 Token 统计

找到：
```
[DEBUG] Token 使用量 - 本次对话: xxx
```

**对比实际消耗**：
- 去 API 后台查看实际消耗
- 估算值应该在实际值的 80-120% 范围内

---

## ⚠️ 已知问题和修复

### 问题 1：AI 失忆

**症状**：AI 说"我不知道..."、"我不记得..."

**原因**：
1. `needs_memory` 条件太严格，没有触发
2. FAISS 搜索没有找到相关记忆
3. 记忆格式有问题

**临时修复**：
加宽 `needs_memory` 关键词：
```python
needs_memory = any(k in user_message for k in [
    '记得', '之前', '刚才', '还记得',
    '知道', '喜欢', '游戏', '角色',  # 扩展关键词
    '什么', '哪个', '谁'  # 疑问词
])
```

---

### 问题 2：身份丢失

**症状**：AI 不表现出"猫娘"或"汪星人"特征

**原因**：
1. `get_user_identity_minimal()` 返回空字符串
2. System Prompt 没有包含身份

**修复**：
在 `build_minimal_messages()` 中添加默认身份：
```python
# 总是包含基础身份（即使获取失败）
if not system_prompt or len(system_prompt) < 10:
    system_prompt = "你是 AI 助手，你是汪星人。友好专业。"
```

---

### 问题 3：Token 统计不准

**症状**：显示 103 tokens，但实际可能是 300-500

**原因**：
1. System Prompt 的 token 没有被正确估算
2. 需要检查字符数统计

**调试**：
查看控制台：
```
[DEBUG] [FunctionCalling] 详细: 统计了 X 条消息，输入字符数: XXX
```

如果输入字符数很少（<100），说明 System Prompt 没有被计入。

---

## 🚀 快速修复建议

**如果 AI 完全失忆：**

临时禁用 Token 优化，恢复完整模式：

在 `chat_window.py` 中注释掉这行：
```python
# request_messages, tools = self.build_minimal_messages(message)
```

改为：
```python
# 临时：使用原来的完整模式
request_messages, tools = self._build_full_messages(message)  # 需要实现
```

---

## 📝 下一步

1. **重启 ue_toolkits**
2. **测试简单问候**（检查身份）
3. **测试记忆召回**（检查 FAISS）
4. **查看控制台日志**
5. **根据日志调整关键词和逻辑**

重启后，把控制台的完整日志发给我，我来帮你调试！

