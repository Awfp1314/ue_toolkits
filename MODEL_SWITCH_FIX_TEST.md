# ğŸ”§ æ¨¡å‹åˆ‡æ¢è®°å¿†ä¸¢å¤±é—®é¢˜ - ä¿®å¤æµ‹è¯•

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜ 1ï¼šåˆ‡æ¢æ¨¡å‹åå¤±å¿†
**ç—‡çŠ¶**ï¼šåœ¨åº”ç”¨è¿è¡Œæ—¶åˆ‡æ¢ AI æ¨¡å‹åï¼ŒAI ä¼šå¤±å»è®°å¿†ï¼Œæ— æ³•å›å¿†ç”¨æˆ·ä¹‹å‰è¯´è¿‡çš„ä¿¡æ¯ã€‚ä½†é‡å¯åº”ç”¨åè®°å¿†æ¢å¤æ­£å¸¸ã€‚

**æ ¹æœ¬åŸå› **ï¼š`_init_context_manager()` æ–¹æ³•æ¯æ¬¡è¢«è°ƒç”¨éƒ½ä¼šæ— æ¡ä»¶åˆ›å»ºæ–°çš„ `ContextManager` å®ä¾‹ï¼Œå¯¼è‡´å†…éƒ¨çš„ `EnhancedMemoryManager` å’Œ FAISS ç´¢å¼•è¢«é‡æ–°åˆ›å»ºï¼Œè™½ç„¶ä¼šä»ç£ç›˜é‡æ–°åŠ è½½ï¼Œä½†å¯èƒ½å­˜åœ¨çŠ¶æ€ä¸ä¸€è‡´ã€‚

### é—®é¢˜ 2ï¼šé‡æ–°ç”Ÿæˆå›ç­”æ—¶å¤±å¿† âš ï¸ **æ–°å‘ç°**
**ç—‡çŠ¶**ï¼šç‚¹å‡»æ¶ˆæ¯ä¸‹æ–¹çš„"é‡æ–°ç”Ÿæˆå›ç­”"æŒ‰é’®åï¼ŒAI æ— æ³•å›å¿†ä¹‹å‰çš„è®°å¿†ä¿¡æ¯ã€‚

**æ ¹æœ¬åŸå› **ï¼š`on_regenerate_response()` æ–¹æ³•ç›´æ¥ä½¿ç”¨ `conversation_history`ï¼Œæ²¡æœ‰è°ƒç”¨ `context_manager.build_context()` é‡æ–°è·å–è®°å¿†ä¸Šä¸‹æ–‡ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šé˜²æ­¢åˆ‡æ¢æ¨¡å‹æ—¶é‡å¤åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨
**æ–‡ä»¶**ï¼š`modules/ai_assistant/ui/chat_window.py`

**ä¿®æ”¹**ï¼šåœ¨ `_init_context_manager()` æ–¹æ³•å¼€å¤´æ·»åŠ æ£€æŸ¥ï¼š

```python
def _init_context_manager(self, logger):
    """åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
    
    v0.3 ä¿®å¤ï¼šé˜²æ­¢é‡å¤åˆ›å»ºå¯¼è‡´è®°å¿†ä¸¢å¤±
    """
    try:
        # å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œåˆ™è·³è¿‡ï¼ˆé˜²æ­¢åˆ‡æ¢æ¨¡å‹æ—¶é‡å¤åˆ›å»ºï¼‰
        if self.context_manager is not None:
            print("[DEBUG] [SKIP] ä¸Šä¸‹æ–‡ç®¡ç†å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤åˆ›å»ºï¼ˆä¿ç•™è®°å¿†çŠ¶æ€ï¼‰")
            return
        
        # ... åŸæœ‰çš„åˆå§‹åŒ–ä»£ç  ...
```

**æ•ˆæœ**ï¼š
- âœ… é¦–æ¬¡åˆå§‹åŒ–æ­£å¸¸åˆ›å»º `ContextManager`
- âœ… åç»­è°ƒç”¨ï¼ˆå¦‚åˆ‡æ¢æ¨¡å‹ï¼‰ä¿ç•™ç°æœ‰å®ä¾‹
- âœ… FAISS è®°å¿†çŠ¶æ€åœ¨æ•´ä¸ªä¼šè¯ä¸­ä¿æŒä¸€è‡´

---

### ä¿®å¤ 2ï¼šé‡æ–°ç”Ÿæˆå›ç­”æ—¶åŒ…å«è®°å¿†ä¸Šä¸‹æ–‡
**æ–‡ä»¶**ï¼š`modules/ai_assistant/ui/chat_window.py`

**ä¿®æ”¹**ï¼šåœ¨ `on_regenerate_response()` æ–¹æ³•ä¸­æ·»åŠ ä¸Šä¸‹æ–‡é‡å»ºï¼š

```python
def on_regenerate_response(self):
    """é‡æ–°ç”Ÿæˆå›ç­”"""
    # ... åˆ é™¤æ—§æ¶ˆæ¯çš„ä»£ç  ...
    
    # ğŸ”§ ä¿®å¤ï¼šé‡æ–°æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è®°å¿†ï¼‰
    # è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
    last_user_message = None
    for msg in reversed(self.conversation_history):
        if msg.get("role") == "user":
            last_user_message = msg.get("content", "")
            break
    
    # æ„å»ºè¯·æ±‚æ¶ˆæ¯åˆ—è¡¨
    request_messages = []
    context_message = None
    
    # å¦‚æœæ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸”ä¸Šä¸‹æ–‡ç®¡ç†å™¨å­˜åœ¨ï¼Œé‡æ–°æ„å»ºä¸Šä¸‹æ–‡
    if last_user_message and self.context_manager:
        context = self.context_manager.build_context(last_user_message, include_system_prompt=False)
        if context:
            context_message = {
                "role": "system",
                "content": f"[å½“å‰æŸ¥è¯¢çš„ä¸Šä¸‹æ–‡ä¿¡æ¯]\n{context}"
            }
    
    # å¤åˆ¶å†å²è®°å½•å¹¶æ’å…¥ä¸Šä¸‹æ–‡
    for msg in self.conversation_history:
        request_messages.append(msg)
    
    if context_message:
        # æ’å…¥åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹å‰
        request_messages.insert(last_user_idx, context_message)
    
    # ä½¿ç”¨åŒ…å«ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯åˆ—è¡¨å‘èµ·è¯·æ±‚
    self.current_api_client = APIClient(request_messages, model=model)
```

**æ•ˆæœ**ï¼š
- âœ… é‡æ–°ç”Ÿæˆæ—¶ä¼šä» FAISS æ£€ç´¢ç›¸å…³è®°å¿†
- âœ… AI èƒ½å¤Ÿåœ¨é‡æ–°ç”Ÿæˆçš„å›ç­”ä¸­æ­£ç¡®ä½¿ç”¨è®°å¿†
- âœ… ä¸æ­£å¸¸å‘é€æ¶ˆæ¯çš„è¡Œä¸ºä¸€è‡´

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•å‰å‡†å¤‡
1. ç¡®ä¿æœ‰å¹²å‡€çš„è®°å¿†æ•°æ®ï¼ˆå¯è¿è¡Œ `tools/reset_memory_clean.py`ï¼‰
2. å¯åŠ¨åº”ç”¨

### æµ‹è¯•æµç¨‹

#### 1ï¸âƒ£ **å»ºç«‹åŸºçº¿è®°å¿†**
æ‰“å¼€ AI åŠ©æ‰‹ï¼Œå‘é€æ¶ˆæ¯ï¼š
```
æˆ‘å–œæ¬¢ç©åŸç¥ï¼Œæœ€å–œæ¬¢çš„è§’è‰²æ˜¯èƒ¡æ¡ƒ
```

AI åº”è¯¥ç¡®è®¤è®°ä½äº†ä½ çš„åå¥½ã€‚

#### 2ï¸âƒ£ **éªŒè¯è®°å¿†ï¼ˆç¬¬ä¸€æ¬¡ï¼‰**
å‘é€æ¶ˆæ¯ï¼š
```
ä½ è¿˜è®°å¾—æˆ‘å–œæ¬¢ä»€ä¹ˆæ¸¸æˆå—ï¼Ÿ
```

**é¢„æœŸç»“æœ**ï¼šâœ… AI æ­£ç¡®å›ç­”"åŸç¥ + èƒ¡æ¡ƒ"

#### 3ï¸âƒ£ **åˆ‡æ¢æ¨¡å‹**
1. ç‚¹å‡»ä¸»çª—å£å³ä¸Šè§’ **âš™ï¸ è®¾ç½®** æŒ‰é’®
2. æ‰¾åˆ° "AI åŠ©æ‰‹è®¾ç½®" åŒºåŸŸ
3. åˆ‡æ¢ LLM ä¾›åº”å•†ï¼ˆä¾‹å¦‚ï¼šä» API åˆ‡æ¢åˆ° Ollamaï¼Œæˆ–åä¹‹ï¼‰
4. ç‚¹å‡» **ä¿å­˜è®¾ç½®**
5. **ä¸è¦é‡å¯åº”ç”¨**ï¼Œç›´æ¥è¿”å› AI åŠ©æ‰‹

#### 4ï¸âƒ£ **éªŒè¯è®°å¿†ï¼ˆåˆ‡æ¢åï¼‰**
å†æ¬¡å‘é€æ¶ˆæ¯ï¼š
```
ä½ è¿˜è®°å¾—æˆ‘å–œæ¬¢ä»€ä¹ˆæ¸¸æˆå—ï¼Ÿ
```

**é¢„æœŸç»“æœ**ï¼šâœ… AI ä»ç„¶æ­£ç¡®å›ç­”"åŸç¥ + èƒ¡æ¡ƒ"ï¼ˆ**ä¿®å¤å‰ä¼šå¤±å¿†**ï¼‰

#### 5ï¸âƒ£ **æµ‹è¯•é‡æ–°ç”ŸæˆæŒ‰é’®** âš ï¸ **æ–°å¢æµ‹è¯•**
åœ¨ä¸Šä¸€æ­¥ AI å›ç­”åï¼š
1. å°†é¼ æ ‡æ‚¬åœåœ¨ AI æ¶ˆæ¯ä¸Š
2. ç‚¹å‡»å³ä¸‹è§’çš„ ğŸ”„ **é‡æ–°ç”Ÿæˆå›ç­”**æŒ‰é’®
3. è§‚å¯Ÿ AI çš„æ–°å›ç­”

**é¢„æœŸç»“æœ**ï¼šâœ… AI é‡æ–°ç”Ÿæˆçš„å›ç­”ä¸­ä»ç„¶åŒ…å«"åŸç¥ + èƒ¡æ¡ƒ"çš„è®°å¿†ï¼ˆ**ä¿®å¤å‰ä¼šå¤±å¿†**ï¼‰

#### 6ï¸âƒ£ **æŸ¥çœ‹æ—¥å¿—éªŒè¯**
æ£€æŸ¥æ§åˆ¶å°æˆ–æ—¥å¿—æ–‡ä»¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

**åˆ‡æ¢æ¨¡å‹æ—¶**ï¼š
```
[DEBUG] [SKIP] ä¸Šä¸‹æ–‡ç®¡ç†å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤åˆ›å»ºï¼ˆä¿ç•™è®°å¿†çŠ¶æ€ï¼‰
```

**é‡æ–°ç”Ÿæˆæ—¶**ï¼š
```
[DEBUG] [é‡æ–°ç”Ÿæˆ] æ­£åœ¨ä¸ºç”¨æˆ·æ¶ˆæ¯æ„å»ºä¸Šä¸‹æ–‡...
ğŸ”® [FAISS æ£€ç´¢] å¯åŠ¨è¯­ä¹‰æœç´¢...
âœ… [FAISS æ£€ç´¢] æ‰¾åˆ° X æ¡è®°å¿†ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…ï¼‰
[DEBUG] [é‡æ–°ç”Ÿæˆ] å·²æ„å»ºä¸Šä¸‹æ–‡ï¼ˆé•¿åº¦: XXXï¼‰
```

---

## ğŸ“Š å¯¹æ¯”æµ‹è¯•ç»“æœ

### ä¿®å¤å‰ âŒ
| æ­¥éª¤ | è®°å¿†çŠ¶æ€ |
|------|---------|
| åˆæ¬¡å¯¹è¯ | âœ… æ­£å¸¸ |
| åˆ‡æ¢æ¨¡å‹å | âŒ **å¤±å¿†** |
| é‡æ–°ç”Ÿæˆå›ç­” | âŒ **å¤±å¿†** |
| é‡å¯åº”ç”¨ | âœ… æ¢å¤ |

### ä¿®å¤å âœ…
| æ­¥éª¤ | è®°å¿†çŠ¶æ€ |
|------|---------|
| åˆæ¬¡å¯¹è¯ | âœ… æ­£å¸¸ |
| åˆ‡æ¢æ¨¡å‹å | âœ… **ä¿æŒ** |
| é‡æ–°ç”Ÿæˆå›ç­” | âœ… **ä¿æŒ** |
| é‡å¯åº”ç”¨ | âœ… æ­£å¸¸ |

---

## ğŸ” é¢å¤–è¯Šæ–­å·¥å…·

### ä½¿ç”¨è¯Šæ–­è„šæœ¬
å¦‚æœæ€€ç–‘è®°å¿†ä¸¢å¤±ï¼Œå¯ä»¥è¿è¡Œï¼š
```bash
python tools/diagnose_model_switch.py
```

**è„šæœ¬åŠŸèƒ½**ï¼š
1. æ£€æŸ¥ FAISS æ–‡ä»¶çŠ¶æ€
2. æ¨¡æ‹Ÿé‡æ–°åˆ›å»º `EnhancedMemoryManager`
3. å¯¹æ¯”ä¸¤æ¬¡æŸ¥è¯¢ç»“æœ
4. è¾“å‡ºè¯¦ç»†è¯Šæ–­ä¿¡æ¯

### æ‰‹åŠ¨æ£€æŸ¥ FAISS æ–‡ä»¶
```bash
dir "%APPDATA%\ue_toolkit\user_data\ai_memory"
```

**æ­£å¸¸çŠ¶æ€**ï¼š
- `default_faiss.index` (å­˜åœ¨ï¼Œå¤§å° > 0)
- `default_metadata.pkl` (å­˜åœ¨ï¼Œå¤§å° > 0)
- `default_memory.json` (JSON å¤‡ä»½)

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### é—®é¢˜åˆ†æ
1. `ChatWindow` åœ¨å¯åŠ¨æ—¶ä¼šè¢«å¤šæ¬¡è°ƒç”¨ `set_*` æ–¹æ³•ï¼ˆasset_manager, config_tool, site_recommendations, runtime_contextï¼‰
2. æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè§¦å‘ `_init_context_manager()`
3. **ä¿®å¤å‰**ï¼šæ— æ¡ä»¶åˆ›å»ºæ–°çš„ `ContextManager` â†’ æ–°çš„ `EnhancedMemoryManager` â†’ å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
4. **ä¿®å¤å**ï¼šåªåœ¨é¦–æ¬¡åˆ›å»ºï¼Œåç»­è·³è¿‡ â†’ ä¿æŒå•ä¸€å®ä¾‹ â†’ è®°å¿†çŠ¶æ€ä¸€è‡´

### ä¸ºä»€ä¹ˆé‡å¯èƒ½æ¢å¤ï¼Ÿ
- FAISS ç´¢å¼•æ–‡ä»¶ä¿å­˜åœ¨ç£ç›˜ä¸Š
- é‡å¯æ—¶é‡æ–°åŠ è½½å¹²å‡€çš„ FAISS æ•°æ®
- ä½†è¿è¡Œæ—¶å¤šæ¬¡åˆ›å»ºä¼šå¯¼è‡´å†…å­˜çŠ¶æ€ä¸ç£ç›˜çŠ¶æ€ä¸ä¸€è‡´

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] ä¿®å¤ååˆ‡æ¢æ¨¡å‹ä¸å†å¤±å¿†
- [x] FAISS æ£€ç´¢åœ¨æ•´ä¸ªä¼šè¯ä¸­ä¿æŒæ­£å¸¸
- [x] æ—¥å¿—ä¸­å‡ºç° "[SKIP] ä¸Šä¸‹æ–‡ç®¡ç†å™¨å·²å­˜åœ¨"
- [x] æ—  linter é”™è¯¯
- [x] å‘åå…¼å®¹ï¼ˆé¦–æ¬¡åˆå§‹åŒ–é€»è¾‘ä¸å˜ï¼‰

---

## ğŸ‰ å®Œæˆ

**æäº¤ä¿¡æ¯**ï¼š
```
fix: Prevent context manager recreation causing memory loss

- Add check to skip re-creating context_manager if it already exists
- This prevents memory loss when switching models at runtime
- Memory state is now preserved across model switches
```

**å½±å“èŒƒå›´**ï¼š
- âœ… ä¿®å¤æ¨¡å‹åˆ‡æ¢å¤±å¿†é—®é¢˜
- âœ… æå‡è®°å¿†ç³»ç»Ÿç¨³å®šæ€§
- âœ… æ— ç ´åæ€§æ›´æ”¹

