# 🧪 如何测试修复效果

## 快速测试（5 分钟）

### 1. 启动程序

```bash
cd "ue_toolkits - ai"
python main.py
```

### 2. 测试 P0-1: UI 阻塞问题

**测试步骤**:

1. 发送任意消息（例如："你好"）
2. 观察 UI 是否立即响应
3. 检查是否还有长时间冻结

**预期结果**:

- ✅ UI 在 100ms 内显示"思考中"动画
- ✅ 不再出现 4-15 秒的冻结
- ✅ 可以随时点击其他按钮

**如果失败**: 检查终端日志，查找 `[DEBUG] [Token优化] 记忆压缩已禁用` 消息

---

### 3. 测试 P0-2: 重复 API 调用问题

**测试步骤**:

1. 清空对话历史或重启程序
2. 按顺序发送以下消息：
   - "你好"
   - "你是谁呀？"
   - "我刚才问你什么了？"
   - "帮我看看有哪些资产"
   - "用 Python 写一个冒泡排序"
   - "UE5 中蓝图和 C++各有什么优缺点？" ⚠️ 关键测试点
   - "你还记得我喜欢什么游戏吗？"
   - "我想学 UE 开发"
3. 观察终端日志中的 API 调用次数

**预期结果**:

- ✅ 每个普通对话只有 1 次 `[COORDINATOR]` 日志
- ✅ 工具调用场景最多 2 次 `[COORDINATOR]` 日志
- ✅ 从测试 6 开始不再出现异常的重复调用

**检查方法**:

```bash
# 在终端日志中搜索
[COORDINATOR] !!! FunctionCallingCoordinator.run() 被调用

# 每个用户消息应该只有 1 次（工具调用除外）
```

**如果失败**:

- 检查是否有 `[BLOCKED] send_message 重入保护触发` 消息
- 检查是否有 `[RETRY_DETECTED]` 消息（不应该出现）

---

## 完整测试（使用 QUICK_TEST.txt）

### 1. 准备测试

```bash
# 清空对话历史或重启程序
python main.py
```

### 2. 执行测试

打开 `QUICK_TEST.txt`，按顺序发送每条测试消息，记录结果：

| 测试 | 消息                             | UI 响应 | API 次数 | 状态 |
| ---- | -------------------------------- | ------- | -------- | ---- |
| 1    | 你好                             | < 100ms | 1        | ✅   |
| 2    | 你是谁呀？                       | < 100ms | 1        | ✅   |
| 3    | 我刚才问你什么了？               | < 100ms | 1        | ✅   |
| 4    | 帮我看看有哪些资产               | < 100ms | 2        | ✅   |
| 5    | 用 Python 写一个冒泡排序         | < 100ms | 1        | ✅   |
| 6    | UE5 中蓝图和 C++各有什么优缺点？ | < 100ms | 1        | ✅   |
| 7    | 你还记得我喜欢什么游戏吗？       | < 100ms | 1        | ✅   |
| 8    | 我想学 UE 开发                   | < 100ms | 1        | ✅   |
| 9    | 从哪里开始？                     | < 100ms | 1        | ✅   |
| 10   | 有哪些配置模板？                 | < 100ms | 2        | ✅   |
| 11   | 给我讲一个关于程序员的笑话       | < 100ms | 1        | ✅   |

### 3. 对比修复前后

**修复前**（来自 QUICK_TEST.txt）:

- 测试 6-10: 卡顿 4-15 秒，调用 2 次 API

**修复后**（预期）:

- 测试 6-10: < 100ms，调用 1 次 API（工具调用除外）

---

## 调试技巧

### 1. 查看 API 调用次数

```bash
# 在终端日志中搜索
[COORDINATOR] !!! FunctionCallingCoordinator.run() 被调用

# 计数每个用户消息对应的 COORDINATOR 调用次数
```

### 2. 查看 UI 响应时间

```bash
# 在终端日志中搜索
[DEBUG] ===== send_message 被调用 =====

# 观察从这条日志到下一条日志的时间间隔
```

### 3. 检查重入保护

```bash
# 在终端日志中搜索
[BLOCKED] send_message 重入保护触发

# 如果出现这条日志，说明重入保护正常工作
```

### 4. 检查重试逻辑

```bash
# 在终端日志中搜索
[RETRY_DETECTED] !!! 检测到重试逻辑被触发

# 修复后不应该出现这条日志
```

---

## 常见问题

### Q1: UI 还是会冻结怎么办？

**A**: 检查以下几点：

1. 确认记忆压缩已禁用（查找 `记忆压缩已禁用` 日志）
2. 检查是否有其他同步操作
3. 查看终端日志，找出阻塞的位置

### Q2: 还是会重复调用 API 怎么办？

**A**: 检查以下几点：

1. 确认重试逻辑已移除（不应该有 `[RETRY_DETECTED]` 日志）
2. 确认重入保护已生效（查找 `[BLOCKED]` 日志）
3. 检查是否有其他地方调用了 `send_message()`

### Q3: Token 消耗增加了怎么办？

**A**: 这是正常的，因为禁用了记忆压缩。解决方案：

1. 短期：接受 Token 增加，优先保证用户体验
2. 长期：将记忆压缩改为异步后台任务

---

## 回滚方法

如果测试失败，可以回退到修复前的状态：

```bash
cd "ue_toolkits - ai"
git reset --hard ad0bebd
```

---

## 成功标准

修复成功的标准：

- ✅ UI 响应时间 < 100ms
- ✅ 普通对话只调用 1 次 API
- ✅ 工具调用最多 2 次 API
- ✅ 不再出现 4-15 秒的冻结
- ✅ 通过 QUICK_TEST.txt 所有测试用例

---

## 下一步

测试通过后：

1. **集成其他组件**（可选）:

   - ScrollController（修复滚动抽搐）
   - SelectionManager（修复文本选中）
   - CursorStyleManager（修复光标样式）

2. **更新文档**:

   - 更新 ISSUE_TRACKER.md
   - 更新 AI_PROJECT_HANDOVER.md

3. **提交最终版本**:
   ```bash
   git add -A
   git commit -m "完成所有UI性能修复"
   ```

---

**祝测试顺利！** 🎉
