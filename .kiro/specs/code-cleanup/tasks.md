# 实现计划

- [ ] 1. 搭建项目基础结构

  - 在 `tools/` 目录下创建 `code_cleanup/` 子目录
  - 创建核心模块文件结构（`__init__.py`、`orchestrator.py`、`scanner.py` 等）
  - 创建配置文件模板 `cleanup_config.json`
  - _需求: 1.1, 1.4_

- [ ] 2. 实现数据模型

  - [ ] 2.1 创建 `models.py` 文件，定义所有数据类
    - 实现 `FileInfo` 数据类（文件信息）
    - 实现 `ImportInfo` 数据类（导入信息）
    - 实现 `FunctionInfo` 数据类（函数信息）
    - 实现 `ClassInfo` 数据类（类信息）
    - 实现 `VariableInfo` 数据类（变量信息）
    - 实现 `Issue` 数据类（问题信息）
    - 实现 `CleanupResult` 数据类（清理结果）
    - _需求: 1.1, 2.5, 10.2_

- [ ] 3. 实现代码扫描器

  - [ ] 3.1 实现 `CodeScanner` 类
    - 实现 `scan_project()` 方法（扫描整个项目）
    - 实现 `scan_python_files()` 方法（扫描 Python 文件）
    - 实现 `scan_config_files()` 方法（扫描配置文件）
    - 实现 `scan_resource_files()` 方法（扫描资源文件）
    - 实现文件过滤逻辑（排除 `.git`、`__pycache__` 等）
    - _需求: 1.1, 1.2, 1.4_

- [ ] 4. 实现 AST 解析器

  - [ ] 4.1 实现 `ASTParser` 类
    - 实现 `parse_file()` 方法（解析文件为 AST）
    - 实现 `extract_imports()` 方法（提取导入语句）
    - 实现 `extract_functions()` 方法（提取函数定义）
    - 实现 `extract_classes()` 方法（提取类定义）
    - 实现 `extract_variables()` 方法（提取变量定义）
    - 实现 AST 缓存机制
    - 添加错误处理（语法错误、编码错误）
    - _需求: 1.2, 1.3_

- [ ] 5. 实现依赖关系图

  - [ ] 5.1 实现 `DependencyGraph` 类
    - 实现 `add_module()` 方法（添加模块节点）
    - 实现 `add_dependency()` 方法（添加依赖边）
    - 实现 `is_reachable()` 方法（检查可达性）
    - 实现 `get_unused_modules()` 方法（获取未使用模块）
    - 实现 `detect_cycles()` 方法（检测循环依赖）
    - 实现依赖图的序列化和反序列化（用于缓存）
    - _需求: 4.1, 4.2, 4.3_

- [ ] 6. 实现分析器基类

  - [ ] 6.1 创建 `analyzers/base.py` 文件
    - 实现 `BaseAnalyzer` 抽象基类
    - 定义 `analyze()` 抽象方法
    - 实现 `get_name()` 方法
    - 实现 `get_category()` 方法
    - 创建 `AnalysisContext` 类（分析上下文）
    - _需求: 1.2_

- [ ] 7. 实现死代码分析器

  - [ ] 7.1 创建 `analyzers/dead_code_analyzer.py` 文件
    - 实现 `DeadCodeAnalyzer` 类（继承 `BaseAnalyzer`）
    - 实现不可达代码检测（`return`/`raise`/`break`/`continue` 后的语句）
    - 实现永远为 False 的条件分支检测
    - 实现未被调用的私有函数检测
    - 实现未被实例化的类检测
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 8. 实现废弃代码分析器

  - [ ] 8.1 创建 `analyzers/deprecated_analyzer.py` 文件
    - 实现 `DeprecatedAnalyzer` 类
    - 实现 `@deprecated` 装饰器检测
    - 实现注释关键词检测（"deprecated"、"废弃"、"已弃用"）
    - 实现废弃代码引用检查
    - 提取废弃原因和替代方案（从注释中）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 9. 实现未使用代码分析器

  - [ ] 9.1 创建 `analyzers/unused_analyzer.py` 文件
    - 实现 `UnusedAnalyzer` 类
    - 实现未使用导入检测
    - 实现未使用函数检测
    - 实现未使用类检测
    - 实现未使用变量检测（排除 `_` 开头）
    - 实现未使用参数检测
    - 实现类型注解导入的特殊处理
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 10. 实现未使用文件检测

  - [ ] 10.1 在 `UnusedAnalyzer` 中添加文件检测功能
    - 使用 `DependencyGraph` 构建文件依赖关系
    - 从入口点（`main.py`）开始追踪可达文件
    - 识别未被导入的 Python 模块
    - 识别未被引用的资源文件
    - 单独标记测试文件并检查有效性
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 11. 实现重复代码分析器

  - [ ] 11.1 创建 `analyzers/duplicate_analyzer.py` 文件
    - 实现 `DuplicateAnalyzer` 类
    - 实现代码块提取（最小 5 行）
    - 实现 Rabin-Karp 哈希算法
    - 实现相似度计算（阈值 80%）
    - 忽略空行和注释
    - 生成重构建议
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 12. 实现配置分析器

  - [ ] 12.1 创建 `analyzers/config_analyzer.py` 文件
    - 实现 `ConfigAnalyzer` 类
    - 实现 JSON 语法验证
    - 实现 `manifest.json` 必需字段检查
    - 实现配置键与代码使用的匹配检查
    - 识别未使用的配置项
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 13. 实现测试文件验证

  - [ ] 13.1 在 `ConfigAnalyzer` 或单独模块中实现测试验证
    - 识别 `tests/` 目录下的所有测试文件
    - 验证导入的模块是否存在
    - 验证测试函数命名（`test_` 前缀）
    - 识别被注释掉的测试用例
    - 标记无效测试文件
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 14. 实现安全验证器

  - [ ] 14.1 创建 `safety_validator.py` 文件
    - 实现 `SafetyValidator` 类
    - 实现公共 API 检查（无 `_` 前缀的顶层函数/类）
    - 实现文档引用检查（扫描 `docs/` 目录）
    - 实现 `requirements.txt` 引用检查
    - 实现影响分析（列出可能受影响的模块）
    - 实现风险评级（高/中/低）
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 15. 实现报告生成器

  - [ ] 15.1 创建 `reporters/` 目录和基类

    - 创建 `reporters/base.py` 文件
    - 实现 `BaseReporter` 抽象基类
    - 定义 `generate()` 抽象方法
    - _需求: 10.1_

  - [ ] 15.2 实现 Markdown 报告生成器

    - 创建 `reporters/markdown_reporter.py` 文件
    - 实现 `MarkdownReporter` 类
    - 生成统计摘要表格
    - 按类别组织问题列表
    - 包含代码片段和建议
    - 生成风险提示部分
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ] 15.3 实现 JSON 报告生成器
    - 创建 `reporters/json_reporter.py` 文件
    - 实现 `JSONReporter` 类
    - 生成结构化的 JSON 数据
    - 包含元数据、统计和问题列表
    - 支持机器可读格式
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 16. 实现清理协调器

  - [ ] 16.1 创建 `orchestrator.py` 文件

    - 实现 `CleanupOrchestrator` 类
    - 实现 `run_cleanup()` 方法（执行完整清理流程）
    - 实现分析器注册和管理
    - 实现进度跟踪和回调
    - 实现结果汇总
    - 实现错误处理和日志记录
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 12.1, 12.2, 12.3, 12.4, 12.5_

  - [ ] 16.2 实现增量清理支持
    - 支持按模块过滤（`--modules` 参数）
    - 支持按类别过滤（`--categories` 参数）
    - 实现清理历史记录
    - 实现清理前后对比
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 17. 实现命令行接口

  - [ ] 17.1 创建 `cli.py` 文件
    - 使用 `argparse` 实现命令行参数解析
    - 实现 `--project-root` 参数（项目根目录）
    - 实现 `--config` 参数（配置文件路径）
    - 实现 `--modules` 参数（指定模块）
    - 实现 `--categories` 参数（指定类别）
    - 实现 `--output` 参数（报告输出目录）
    - 实现 `--format` 参数（报告格式：markdown/json/both）
    - 实现 `--dry-run` 参数（只分析不删除）
    - 实现进度显示（使用 `tqdm` 或简单的百分比）
    - _需求: 1.1, 12.1, 12.2_

- [ ] 18. 实现配置管理

  - [ ] 18.1 创建 `config.py` 文件
    - 实现配置文件加载（JSON 格式）
    - 实现配置验证（使用 JSON Schema）
    - 实现默认配置
    - 实现配置合并（命令行参数覆盖配置文件）
    - _需求: 1.1_

- [ ] 19. 实现缓存机制

  - [ ] 19.1 创建 `cache.py` 文件
    - 实现 AST 缓存（基于文件修改时间）
    - 实现依赖图缓存
    - 实现分析结果缓存
    - 实现缓存清理（过期缓存）
    - 使用 `pickle` 或 `json` 序列化
    - _需求: 12.3_

- [ ] 20. 实现备份和回滚机制

  - [ ] 20.1 创建 `backup.py` 文件
    - 实现文件备份（删除前自动备份）
    - 实现备份目录管理
    - 实现回滚功能（恢复备份）
    - 实现备份清理（保留最近 N 个备份）
    - _需求: 11.5, 12.5_

- [ ] 21. 集成所有组件

  - [ ] 21.1 在 `orchestrator.py` 中集成所有分析器

    - 注册所有分析器实例
    - 实现分析器执行顺序
    - 实现分析器间的数据共享（通过 `AnalysisContext`）
    - 实现错误隔离（单个分析器失败不影响其他）
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 21.2 集成安全验证器

    - 在生成报告前调用安全验证
    - 标记高风险操作
    - 生成影响分析报告
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ] 21.3 集成报告生成器
    - 根据配置选择报告格式
    - 生成多种格式的报告
    - 保存报告到指定目录
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 22. 性能优化

  - [ ] 22.1 实现并行处理

    - 使用 `concurrent.futures.ThreadPoolExecutor` 并行扫描文件
    - 使用 `concurrent.futures.ProcessPoolExecutor` 并行解析 AST
    - 实现独立分析器的并行执行
    - 添加 `--max-workers` 参数控制并发数
    - _需求: 1.1, 1.2_

  - [ ] 22.2 实现内存优化
    - 大文件使用流式读取
    - 分批处理大量文件
    - 及时释放不再使用的数据结构
    - _需求: 1.1, 1.2_

- [ ]\* 23. 编写文档

  - [ ]\* 23.1 创建 `README.md` 文件

    - 编写工具简介
    - 编写安装说明
    - 编写使用示例
    - 编写配置说明
    - 编写常见问题解答
    - _需求: 1.1_

  - [ ]\* 23.2 创建 `ARCHITECTURE.md` 文件
    - 描述系统架构
    - 描述各组件职责
    - 描述数据流
    - 描述扩展点
    - _需求: 1.1_

- [ ]\* 24. 编写测试

  - [ ]\* 24.1 创建测试数据

    - 创建包含死代码的示例文件
    - 创建包含废弃代码的示例文件
    - 创建包含未使用代码的示例文件
    - 创建包含重复代码的示例文件
    - 创建配置文件示例
    - _需求: 1.1_

  - [ ]\* 24.2 编写单元测试

    - 测试 `ASTParser` 的各个方法
    - 测试 `DependencyGraph` 的各个方法
    - 测试各个分析器的检测规则
    - 测试 `SafetyValidator` 的验证逻辑
    - 测试报告生成器的输出格式
    - _需求: 1.1_

  - [ ]\* 24.3 编写集成测试
    - 在测试项目上运行完整清理流程
    - 验证报告内容的正确性
    - 测试增量清理功能
    - 测试备份和回滚功能
    - _需求: 1.1_

- [ ] 25. 在实际项目上运行清理

  - [ ] 25.1 在 UE Toolkit 项目上运行清理分析

    - 使用 `--dry-run` 模式运行
    - 生成完整的清理报告
    - 审查报告中的所有问题
    - 验证分析结果的准确性
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ] 25.2 根据报告进行代码清理
    - 按优先级处理问题（高 → 中 → 低）
    - 先处理安全的清理（未使用导入等）
    - 人工审查高风险清理（公共 API 等）
    - 分批次提交清理结果
    - 每次清理后运行测试验证
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 26. 生成最终清理报告
  - [ ] 26.1 生成清理前后对比报告
    - 统计清理前的代码行数
    - 统计清理后的代码行数
    - 统计删除的文件数
    - 统计修复的问题数
    - 生成清理摘要
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 12.4_
